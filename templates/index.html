<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCB AI Hackathon Submission</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body {
          max-width: 550px; 
          margin: 40px auto; 
          padding: 0 10px; 
          font: 18px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; 
          color: #444 
        } 


        h1, h2, h3 {
          line-height: 1.2
        }

        #submit-response-button, #comparison-result {
            display: none;
        }

				#start-game-button, #submit-response-button, #multiplayer-button {
						margin-top: 50px; /* Adjust this value as needed */
				}

        .center {
            text-align: center;
        }

        #ethical-question {
              margin-bottom: 20px;
        }

        table {
          width: 100%;
          border-collapse: collapse;
        }

        #machine-response-container {
            visibility: hidden;
        }

        #machine-response-container.visible {
            visibility: visible;
        }

        #text-container-container {
            visibility: hidden;
        }

        #text-container-container.visible {
            visibility: visible;
        }

    </style>
</head>
<body>
    <div id="ethical-question">
    </div>
		<div>
      <table style="text-align:center;">
        <tr>
          <th>
            <label id='text-container-label' for="text-container" style="display:none;">Your response:</label>
          </th>
          <th>
            <label id='machine-response-label' for="machine-response" style="display:none;">Opponent response:</label>
          </th>
        </tr>
        <tr>
          <td id='text-container-container'>
            <textarea id='text-container' rows="12" name='text-container'></textarea>
          </td>
          <td id='machine-response-container'>
            <textarea id='machine-response' rows="12" name='machine-response'></textarea>
          </td>
        </tr>
      </table>
		</div>

    <div class="center">
      <br />
      <div id="comparison-result"></div>
      <br />
      <button id="submit-response-button">Compare Results with AI</button>
      <button id="start-game-button">New Game (vs. AI)</button>
      <button id="multiplayer-button">New Game (vs. human)</button>
      <div id="multiplayer-input" style="display: none;">
        <input type="text" id="game-code-input" placeholder="Enter game code">
#         <button id="join-game-button">Join Game</button>
      </div>
    </div>

		<script>
				const socket = io();
				let gameId = null;
        let playerId = null;
        let waitingForOtherPlayer = false;

				const startGameButton = document.getElementById('start-game-button');
				const textContainerContainer = document.getElementById('text-container-container');
				const textContainer = document.getElementById('text-container');
				const submitResponseButton = document.getElementById('submit-response-button');
				const machineResponseContainer = document.getElementById('machine-response-container');
        const machineResponse = document.getElementById('machine-response');
        const textContainerLabel = document.getElementById('text-container-label');
        const machineResponseLabel = document.getElementById('machine-response-label');

				const comparisonResult = document.getElementById('comparison-result');
				const ethicalQuestion = document.getElementById('ethical-question');

        let bothRespondedDotsInterval;

				function streamText(container, text, delay = 20) {
							container.value = ''; // Clear any existing text
							let index = 0;

							return new Promise((resolve) => {
									function addChar() {
											if (index < text.length) {
													container.value += text.charAt(index);
													index++;
													setTimeout(addChar, delay);
											} else {
													resolve(); // Resolve the promise when streaming is complete
											}
									}
									
									addChar();
							});
				}

        function clearGame() {
						// Make sure there's nothig from the previous game
						//machineResponseContainer.style.display = 'none';
            machineResponseContainer.classList.remove('visible');
						//textContainerContainer.style.display = 'none';
            textContainerContainer.classList.remove('visible');

						textContainer.value = '';
						machineResponse.value = '';

						comparisonResult.innerText = '';
						comparisonResult.style.display = 'none';
            // Reset color
						comparisonResult.style.color = '#444';
            // Reset the ethical question
            ethicalQuestion.innerHTML = '';
            // Reset the labels
            textContainerLabel.style.display = 'none';
            machineResponseLabel.style.display = 'none';
        }
					
				function startGame() {
            startGameButton.style.display = 'none';
            clearGame();

						// Also hide the new multiplayer game option
						document.getElementById('multiplayer-button').style.display = 'none';

						fetch('/generate', {
								method: 'POST',
						})
						.then(response => response.json())
						.then(data => {
                console.log("Data from server");
                console.log(data);

								ethicalQuestion.innerHTML = data.question;
								//textContainerContainer.style.display = 'table';
                textContainerContainer.classList.add('visible');
								submitResponseButton.style.display = 'inline';
						})
						.catch(error => console.error('Error:', error));
				}

				function compareBothResponses() {
							comparisonResult.innerText = 'Comparing responses...';
							comparisonResult.style.display = 'inline';
              // Make both labels 
              textContainerLabel.style.display = 'inline';
              //machineResponseLabel.style.display = 'table';
              machineResponseContainer.classList.add('visible');
							
							fetch('/compare_responses', {
									method: 'POST',
									headers: {
											'Content-Type': 'application/json'
									},
									body: JSON.stringify({
											human_response: textContainer.value,
											machine_response: machineResponse.value,
											ethical_question: ethicalQuestion.innerHTML,
									})
							})
							.then(response => response.json())
							.then(data => {
									// Hide the "submit" button
									if (data.winner === 'human') {
											// Put the text in green
											comparisonResult.style.color = 'green';
											// Get the text from the server
											comparisonResult.innerText = 'You win!';
									} else {
											// Put the text in red
											comparisonResult.style.color = 'red';
											// Get the text from the server
											comparisonResult.innerText = 'You lose!';
									}
									// Make the newGameButton visible
									startGameButton.style.display = 'inline';
                  // Make the multiplayer button visible
                  document.getElementById('multiplayer-button').style.display = 'inline';

									console.log(data);
							})
							.catch(error => console.error('Error:', error));
					}

					function getMachineResponseAndCompare() {
							data_for_request = {
									ethical_question: ethicalQuestion.innerHTML,
							}
							console.log("Data for request");
							console.log(data_for_request);
							fetch('/get_machine_response', {
									method: 'POST',
									headers: {
											'Content-Type': 'application/json'
									},
									body: JSON.stringify(data_for_request)
							})
							.then(response => response.json())
							.then(data => {
									submitResponseButton.style.display = 'none';
									//machineResponseContainer.style.display = 'table';
                  machineResponseContainer.classList.add('visible');
									// Don't run any code until the text has finished streaming
									streamText(machineResponse, data.text).then(() => {
										// Do nothing
										setTimeout(() => {
											compareBothResponses();
										}, 10);
									});
							})
							.catch(error => console.error('Error:', error));
				}

				startGameButton.addEventListener('click', () => {
						startGame()
				});

				document.getElementById('multiplayer-button').addEventListener('click', () => {
            clearGame();
						document.getElementById('multiplayer-input').style.display = 'block';
						document.getElementById('multiplayer-button').style.display = 'none';
            startGameButton.style.display = 'none';
				});

				document.getElementById('join-game-button').addEventListener('click', () => {
						const gameCode = document.getElementById('game-code-input').value;
						socket.emit('join_game', { game_code: gameCode });
				});

				socket.on('game_joined', (data) => {
						playerId = data.player_id;
						gameId = document.getElementById('game-code-input').value;
						document.getElementById('multiplayer-input').style.display = 'none';
						document.getElementById('start-game-button').style.display = 'none';
						document.getElementById('multiplayer-button').style.display = 'none';
						
						waitingForOtherPlayer = true;
						comparisonResult.innerText = 'Waiting for other player to join...';
						comparisonResult.style.display = 'inline';
				});

				socket.on('game_ready', (data) => {
						if (waitingForOtherPlayer) {
								waitingForOtherPlayer = false;
								ethicalQuestion.innerHTML = data.question;
								textContainerContainer.style.display = 'block';
								submitResponseButton.style.display = 'inline';
								submitResponseButton.innerText = 'Submit Response';
								comparisonResult.style.display = 'none';
						}
				});

				socket.on('game_full', () => {
						alert('This game is already full. Please try a different game code.');
				});

				socket.on('game_full', () => {
						alert('This game is already full. Please try a different game code.');
				});

				socket.on('both_responded', (data) => {
            console.log("Just heard that both players have responded");
            console.log("And they responded on the right room");
            responses = data.responses;
            // Get the keys of resopnses
            responses = Object.keys(responses);
            // Get the key which does not match the playerId
            otherPlayerId = responses.filter((response) => response !== playerId)[0];
            // Get the response of the other player
            otherPlayerResponse = data.responses[otherPlayerId];
            // Show the response of the other player
            console.log("The other player said:");
            console.log(otherPlayerResponse);

            // Show the response of the other player
            //machineResponseContainer.style.display = 'block';
            machineResponseContainer.classList.add('visible');
            
            // Don't run any code until the text has finished streaming
            streamText(machineResponse, otherPlayerResponse).then(() => {
              // Do nothing
              // Set 10-second timeout before continuing
              setTimeout(() => {
                return 
              }, 10);
            });

            // Make the number of ellipses change
            let ellipses = 3;
            comparisonResult.innerText = 'Comparing responses' + '.'.repeat(ellipses);
            // Mark this to be halted later once the comparison is done
            bothRespondedDotsInterval = setInterval(() => {
                comparisonResult.innerText = 'Comparing responses' + '.'.repeat(ellipses);
                ellipses = (ellipses + 1) % 4;
            }, 500);
            
				});

				socket.on('game_result', (data) => {
            // Make the ellipses setInterval() stop
            // If bothRespondedDotsInterval is not defined, this will do nothing
            if (bothRespondedDotsInterval) {
                clearInterval(bothRespondedDotsInterval);
            } else {
                console.log("Not clearing interval")
            }
            
						if (data.winner === playerId) {
								comparisonResult.style.color = 'green';
								comparisonResult.innerText = 'You win!';
						} else {
								comparisonResult.style.color = 'red';
								comparisonResult.innerText = 'You lose!';
						}
            document.getElementById('multiplayer-button').style.display = 'inline';
						startGameButton.style.display = 'inline';
				});

				// Modify the submitResponseButton event listener
				submitResponseButton.addEventListener('click', () => {
						if (gameId) {
								// Multiplayer mode
								socket.emit('submit_response', {
										game_code: gameId,
										player_id: playerId,
										response: textContainer.value
								});
								submitResponseButton.style.display = 'none';
								comparisonResult.innerText = 'Waiting for other player...';
								comparisonResult.style.display = 'inline';

						} else {
								// Single player mode (keep your existing code here)
								getMachineResponseAndCompare();
						}
				});

		</script>
</body>
</html>

